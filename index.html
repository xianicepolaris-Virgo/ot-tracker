<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒä¼‘ç®¡å®¶ - ä¸“ä¸šè¿›é˜¶ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <script src="https://unpkg.com/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <style>
        body { background-color: #f5f7fa; margin: 0; padding: 10px; font-family: "Helvetica Neue",Arial,sans-serif; }
        .app-container { max-width: 600px; margin: 0 auto; }
        .header-card { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; border-radius: 12px; border: none; margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.3);
        }
        .total-display { font-size: 48px; font-weight: bold; margin: 10px 0; }
        .footer { text-align: center; color: #909399; font-size: 12px; margin-top: 20px; }
        .el-button--circle { font-size: 18px; }
    </style>
</head>
<body>
<div id="app" class="app-container">
    <el-card class="header-card" v-loading="loading" element-loading-background="rgba(102, 126, 234, 0.7)">
        <div v-if="user" style="display: flex; justify-content: space-between; align-items: center;">
            <el-tag effect="dark" size="small" style="background: rgba(255,255,255,0.3); border:none;">ğŸ‘¤ {{ user }}</el-tag>
            <el-dropdown @command="handleUserCommand">
                <span style="color: white; cursor: pointer; font-size: 14px;">è´¦æˆ·ç®¡ç† <i class="el-icon-arrow-down"></i></span>
                <el-dropdown-menu slot="dropdown">
                    <el-dropdown-item v-for="u in userList" :key="u" :command="u">{{ u }}</el-dropdown-item>
                    <el-dropdown-item command="ADD_NEW" divided>+ æ–°æˆå‘˜</el-dropdown-item>
                    <el-dropdown-item command="LOGOUT" style="color: #F56C6C;">é€€å‡ºå½“å‰</el-dropdown-item>
                </el-dropdown-menu>
            </el-dropdown>
        </div>
        <div v-if="user" style="text-align: center; margin-top: 10px;">
            <div style="font-size: 13px; opacity: 0.8;">å½“å‰å¯è°ƒä¼‘ä½™é¢</div>
            <div class="total-display">{{ total.toFixed(1) }} <small style="font-size: 18px">å¤©</small></div>
        </div>
    </el-card>

    <div style="text-align: center; margin-bottom: 20px;">
        <el-button type="primary" icon="el-icon-plus" round @click="openDialog('ADD')">æ–°å¢è®°å½• (åŠ ç­/è°ƒä¼‘)</el-button>
    </div>

    <el-table :data="logs" stripe size="small" style="width: 100%; border-radius: 10px;" v-if="user">
        <el-table-column prop="logDate" label="æ—¥æœŸ" width="105"></el-table-column>
        <el-table-column label="å¤©æ•°" width="70">
            <template slot-scope="scope">
                <b :style="{color: scope.row.amount > 0 ? '#67C23A' : '#F56C6C'}">
                    {{ scope.row.amount > 0 ? '+' + scope.row.amount : scope.row.amount }}
                </b>
            </template>
        </el-table-column>
        <el-table-column prop="note" label="å¤‡æ³¨" show-overflow-tooltip></el-table-column>
        <el-table-column label="æ“ä½œ" width="100" align="right">
            <template slot-scope="scope">
                <el-button type="text" icon="el-icon-edit" @click="openDialog('EDIT', scope.row)"></el-button>
                <el-button type="text" icon="el-icon-delete" style="color: #F56C6C" @click="handleDelete(scope.row)"></el-button>
            </template>
        </el-table-column>
    </el-table>

    <div class="footer">æ•°æ®å·²åŒæ­¥è‡³ LeanCloud Â· ä»…ä¾›å†…éƒ¨å­¦ä¹ ä½¿ç”¨</div>

    <el-dialog :title="isEdit ? 'ç¼–è¾‘è®°å½•' : 'æ–°å¢åŠ ç­/è°ƒä¼‘'" :visible.sync="dialogVisible" width="90%" center>
        <el-form label-position="top">
            <el-form-item label="æ—¥æœŸ">
                <el-date-picker v-model="form.logDate" type="date" placeholder="é€‰æ‹©æ—¥æœŸ" style="width: 100%" value-format="yyyy-MM-dd"></el-date-picker>
            </el-form-item>
            <el-form-item label="å¤©æ•°å˜åŠ¨ (åŠ ç­å¡«æ­£æ•°ï¼Œè°ƒä¼‘å¡«è´Ÿæ•°)">
                <el-input-number v-model="form.amount" :precision="1" :step="0.5" style="width: 100%"></el-input-number>
            </el-form-item>
            <el-form-item label="å¤‡æ³¨è¯´æ˜">
                <el-input v-model="form.note" placeholder="å¦‚ï¼šXXé¡¹ç›®åŠ ç­ / å‘¨äº”è°ƒä¼‘"></el-input>
            </el-form-item>
        </el-form>
        <div slot="footer">
            <el-button @click="dialogVisible = false">å–æ¶ˆ</el-button>
            <el-button type="primary" @click="submitForm" :loading="loading">ä¿å­˜åˆ°äº‘ç«¯</el-button>
        </div>
    </el-dialog>
</div>

<script>
// --- é…ç½®ä¿¡æ¯ (å·²å¡«å…¥ä½ çš„ AppID å’Œ Key) ---
AV.init({
  appId: "Mz4sDbBvDWL73JIex95G2Oyk-gzGzoHsz",
  appKey: "drSmabDFOB0U5L0p49KVBqWP",
  serverURL: "https://mz4sdbbv.lc-cn-n1-shared.com" 
});
const OTLog = AV.Object.extend('OTLog');

new Vue({
    el: '#app',
    data: {
        user: localStorage.getItem('ot_user') || '',
        userList: JSON.parse(localStorage.getItem('ot_user_list')) || [],
        loading: false,
        total: 0,
        logs: [],
        dialogVisible: false,
        isEdit: false,
        form: { id: '', logDate: '', amount: 1, note: '' }
    },
    mounted() {
        if (!this.user) this.forceLogin();
        else this.fetchData();
    },
    methods: {
        // å¼ºåˆ¶å§“åè¾“å…¥
        forceLogin() {
            this.$prompt('è¯·è¾“å…¥å§“åå¼€å§‹è®°å½•', 'åˆå§‹åŒ–', {
                confirmButtonText: 'ç¡®å®š', showCancelButton: false, inputPattern: /\S+/, inputErrorMessage: 'å§“åä¸èƒ½ä¸ºç©º'
            }).then(({ value }) => {
                this.user = value;
                if (!this.userList.includes(value)) this.userList.push(value);
                this.saveLocal();
                this.fetchData();
            });
        },
        saveLocal() {
            localStorage.setItem('ot_user', this.user);
            localStorage.setItem('ot_user_list', JSON.stringify(this.userList));
        },
        // æŠ“å–æ•°æ®
        async fetchData() {
            if (!this.user) return;
            this.loading = true;
            try {
                const query = new AV.Query('OTLog');
                query.equalTo('user', this.user);
                query.descending('logDate'); // æŒ‰ç”¨æˆ·å¡«å†™çš„æ—¥æœŸæ’åº
                const results = await query.find();
                this.logs = results.map(r => ({
                    id: r.id,
                    logDate: r.get('logDate'),
                    amount: r.get('amount'),
                    note: r.get('note')
                }));
                this.total = this.logs.reduce((sum, r) => sum + r.amount, 0);
            } finally { this.loading = false; }
        },
        // æ‰“å¼€å¼¹çª—ï¼ˆæ–°å¢æˆ–ç¼–è¾‘ï¼‰
        openDialog(mode, row = null) {
            this.isEdit = mode === 'EDIT';
            if (this.isEdit) {
                this.form = { ...row };
            } else {
                this.form = { id: '', logDate: new Date().toISOString().split('T')[0], amount: 1, note: '' };
            }
            this.dialogVisible = true;
        },
        // æäº¤è¡¨å•ï¼ˆä¿å­˜æˆ–æ›´æ–°ï¼‰
        async submitForm() {
            if (!this.form.logDate) return this.$message.error('è¯·é€‰æ‹©æ—¥æœŸ');
            this.loading = true;
            try {
                let log;
                if (this.isEdit) {
                    log = AV.Object.createWithoutData('OTLog', this.form.id);
                } else {
                    log = new OTLog();
                    log.set('user', this.user);
                }
                log.set('logDate', this.form.logDate);
                log.set('amount', this.form.amount);
                log.set('note', this.form.note);
                await log.save();
                this.$message.success(this.isEdit ? 'å·²æˆåŠŸä¿®æ”¹' : 'å·²æˆåŠŸæ–°å¢');
                this.dialogVisible = false;
                this.fetchData();
            } catch (e) {
                this.$message.error('äº‘ç«¯ä¿å­˜å¤±è´¥');
            } finally { this.loading = false; }
        },
        // åˆ é™¤è®°å½•
        handleDelete(row) {
            this.$confirm(`ç¡®å®šè¦åˆ é™¤ ${row.logDate} çš„è¿™æ¡è®°å½•å—ï¼Ÿ`, 'è­¦å‘Š', {
                confirmButtonText: 'ç¡®å®š', cancelButtonText: 'å–æ¶ˆ', type: 'warning'
            }).then(async () => {
                const log = AV.Object.createWithoutData('OTLog', row.id);
                await log.destroy();
                this.$message.success('å·²åˆ é™¤');
                this.fetchData();
            });
        },
        handleUserCommand(cmd) {
            if (cmd === 'ADD_NEW') this.forceLogin();
            else if (cmd === 'LOGOUT') { localStorage.removeItem('ot_user'); location.reload(); }
            else { this.user = cmd; this.saveLocal(); this.fetchData(); }
        }
    }
})
</script>
</body>
</html>
