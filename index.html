<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒä¼‘ç®¡å®¶ - äº‘ç«¯ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <script src="https://unpkg.com/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <style>
        body { background-color: #f5f7fa; margin: 0; padding: 15px; font-family: "Helvetica Neue",Arial,sans-serif; }
        .app-container { max-width: 500px; margin: 0 auto; }
        .header-card { 
            background: linear-gradient(135deg, #1890ff 0%, #36cfc9 100%); 
            color: white; border-radius: 12px; border: none; min-height: 160px;
            box-shadow: 0 4px 12px rgba(24, 144, 255, 0.3);
        }
        .total-display { font-size: 52px; font-weight: bold; margin: 10px 0; }
        .op-btn-group p { font-size: 13px; color: #606266; margin-top: 8px; }
        .footer { text-align: center; color: #909399; font-size: 12px; margin-top: 30px; }
    </style>
</head>
<body>
<div id="app" class="app-container">
    <el-card class="header-card" v-loading="loading" element-loading-background="rgba(24, 144, 255, 0.8)">
        <div v-if="user" style="display: flex; justify-content: space-between; align-items: center;">
            <el-tag effect="plain" size="small" style="background: rgba(255,255,255,0.2); color: white; border:none;">
                ğŸ‘¤ {{ user }}
            </el-tag>
            <el-dropdown trigger="click" @command="handleUserCommand">
                <span class="el-dropdown-link" style="color: white; cursor: pointer; font-size: 14px;">
                    ç®¡ç†è´¦æˆ· <i class="el-icon-setting el-icon--right"></i>
                </span>
                <el-dropdown-menu slot="dropdown">
                    <el-dropdown-item v-for="u in userList" :key="u" :command="u">{{ u }}</el-dropdown-item>
                    <el-dropdown-item command="ADD_NEW" divided style="color: #409EFF; font-weight: bold;">+ æ·»åŠ æ–°æˆå‘˜</el-dropdown-item>
                    <el-dropdown-item command="LOGOUT" style="color: #F56C6C;">é€€å‡ºå½“å‰</el-dropdown-item>
                </el-dropdown-menu>
            </el-dropdown>
        </div>
        
        <div v-if="user" style="text-align: center; margin-top: 20px;">
            <div style="font-size: 14px; opacity: 0.9;">å½“å‰å‰©ä½™è°ƒä¼‘ (å¤©)</div>
            <div class="total-display">{{ total.toFixed(1) }}</div>
        </div>
    </el-card>

    <el-row :gutter="15" style="margin-top: 25px; text-align: center;" class="op-btn-group">
        <el-col :span="8">
            <el-button type="primary" icon="el-icon-plus" circle @click="addRecord(1, 'åŠ ç­')" :disabled="!user"></el-button>
            <p>åŠ ç­ 1å¤©</p>
        </el-col>
        <el-col :span="8">
            <el-button type="success" icon="el-icon-plus" circle @click="addRecord(0.5, 'åŠ ç­')" :disabled="!user"></el-button>
            <p>åŠ ç­ 0.5å¤©</p>
        </el-col>
        <el-col :span="8">
            <el-button type="warning" icon="el-icon-minus" circle @click="showUseDialog = true" :disabled="!user"></el-button>
            <p>ç”¨è°ƒä¼‘</p>
        </el-col>
    </el-row>

    <el-table :data="logs" style="width: 100%; border-radius: 8px; margin-top: 20px;" size="mini" stripe v-if="user">
        <el-table-column prop="date" label="æ—¥æœŸ" width="110"></el-table-column>
        <el-table-column label="å˜åŠ¨">
            <template slot-scope="scope">
                <span :style="{color: scope.row.amount > 0 ? '#67C23A' : '#F56C6C', fontWeight: 'bold'}">
                    {{ scope.row.amount > 0 ? '+' + scope.row.amount : scope.row.amount }}
                </span>
            </template>
        </el-table-column>
        <el-table-column prop="note" label="å¤‡æ³¨" show-overflow-tooltip></el-table-column>
    </el-table>

    <div class="footer">
        å¤šäººåä½œè°ƒä¼‘ç³»ç»Ÿ Â· å®æ—¶åŒæ­¥äº‘ç«¯
    </div>

    <el-dialog title="ä½¿ç”¨è°ƒä¼‘å¤©æ•°" :visible.sync="showUseDialog" width="90%" center>
        <el-input-number v-model="useVal" :step="0.5" :min="0.5" style="width:100%"></el-input-number>
        <el-input v-model="useNote" placeholder="è°ƒä¼‘äº‹ç”±" style="margin-top:15px"></el-input>
        <span slot="footer"><el-button type="primary" @click="handleUse" style="width: 100%">ç¡®è®¤æ‰£å‡</el-button></span>
    </el-dialog>
</div>

<script>
// --- æ ¸å¿ƒé…ç½®ï¼ˆå·²æ ¹æ®æ‚¨çš„ä¿¡æ¯æ›´æ–°ï¼‰ ---
AV.init({
  appId: "Mz4sDbBvDWL73JIex95G2Oyk-gzGzoHsz",
  appKey: "drSmabDFOB0U5L0p49KVBqWP",
  serverURL: "https://mz4sdbbv.lc-cn-n1-shared.com" 
});

const OTLog = AV.Object.extend('OTLog');

new Vue({
    el: '#app',
    data: {
        user: localStorage.getItem('ot_user') || '', 
        userList: JSON.parse(localStorage.getItem('ot_user_list')) || [], 
        loading: false,
        total: 0,
        logs: [],
        showUseDialog: false,
        useVal: 0.5,
        useNote: ''
    },
    async mounted() {
        if (!this.user) {
            this.forceLogin();
        } else {
            this.fetchData();
        }
    },
    methods: {
        forceLogin() {
            this.$prompt('æ¬¢è¿ï¼è¯·è¾“å…¥å§“åå¼€å§‹è®°å½•', 'åˆå§‹åŒ–', {
                confirmButtonText: 'ç¡®å®š',
                showCancelButton: false,
                inputPattern: /\S+/,
                inputErrorMessage: 'å§“åä¸èƒ½ä¸ºç©º'
            }).then(({ value }) => {
                this.user = value;
                if (!this.userList.includes(value)) {
                    this.userList.push(value);
                }
                this.saveLocalInfo();
                this.fetchData();
            });
        },
        saveLocalInfo() {
            localStorage.setItem('ot_user', this.user);
            localStorage.setItem('ot_user_list', JSON.stringify(this.userList));
        },
        handleUserCommand(cmd) {
            if (cmd === 'ADD_NEW') {
                this.forceLogin();
            } else if (cmd === 'LOGOUT') {
                localStorage.removeItem('ot_user');
                location.reload();
            } else {
                this.user = cmd;
                this.saveLocalInfo();
                this.fetchData();
            }
        },
        async fetchData() {
            if (!this.user) return;
            this.loading = true;
            try {
                const query = new AV.Query('OTLog');
                query.equalTo('user', this.user);
                query.descending('createdAt');
                query.limit(20);
                const results = await query.find();
                this.logs = results.map(r => ({
                    date: r.createdAt.toLocaleDateString(),
                    amount: r.get('amount'),
                    note: r.get('note')
                }));
                this.total = this.logs.reduce((sum, r) => sum + r.amount, 0);
            } catch (err) {
                this.$message.error('äº‘ç«¯è¯»å–å¤±è´¥');
            } finally {
                this.loading = false;
            }
        },
        async addRecord(amt, note) {
            this.loading = true;
            try {
                const log = new OTLog();
                log.set('user', this.user);
                log.set('amount', amt);
                log.set('note', note);
                await log.save();
                this.$message.success('äº‘ç«¯å·²æ›´æ–°');
                this.fetchData();
            } catch (err) {
                this.$message.error('åŒæ­¥å¤±è´¥');
            } finally {
                this.loading = false;
            }
        },
        handleUse() {
            this.addRecord(-this.useVal, this.useNote || 'è°ƒä¼‘ä½¿ç”¨');
            this.showUseDialog = false;
            this.useNote = '';
        }
    }
})
</script>
</body>
</html>
