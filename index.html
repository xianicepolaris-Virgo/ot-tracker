<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒä¼‘ç®¡å®¶ - ä¸¥è°¨ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <script src="https://unpkg.com/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <style>
        body { background-color: #f5f7fa; margin: 0; padding: 10px; font-family: "Helvetica Neue",Arial,sans-serif; }
        .app-container { max-width: 600px; margin: 0 auto; }
        .header-card { 
            background: linear-gradient(135deg, #1890ff 0%, #36cfc9 100%); 
            color: white; border-radius: 12px; border: none; margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(24, 144, 255, 0.3);
        }
        .total-display { font-size: 48px; font-weight: bold; margin: 10px 0; }
        .footer { text-align: center; color: #909399; font-size: 12px; margin-top: 20px; }
        .type-plus { color: #67C23A; font-weight: bold; }
        .type-minus { color: #F56C6C; font-weight: bold; }
    </style>
</head>
<body>
<div id="app" class="app-container">
    <el-card class="header-card" v-loading="loading">
        <div v-if="user" style="display: flex; justify-content: space-between; align-items: center;">
            <el-tag effect="dark" size="small" style="background: rgba(255,255,255,0.3); border:none;">ğŸ‘¤ {{ user }}</el-tag>
            <el-dropdown @command="handleUserCommand">
                <span style="color: white; cursor: pointer; font-size: 14px;">ç®¡ç† <i class="el-icon-arrow-down"></i></span>
                <el-dropdown-menu slot="dropdown">
                    <el-dropdown-item command="MANAGE_MEMBERS" icon="el-icon-user">æˆå‘˜ç®¡ç†</el-dropdown-item>
                    <el-dropdown-item command="ADD_NEW" icon="el-icon-plus">æ·»åŠ æ–°æˆå‘˜</el-dropdown-item>
                    <el-dropdown-item command="LOGOUT" icon="el-icon-switch-button" style="color: #F56C6C;">é€€å‡ºå½“å‰</el-dropdown-item>
                </el-dropdown-menu>
            </el-dropdown>
        </div>
        <div v-if="user" style="text-align: center; margin-top: 10px;">
            <div style="font-size: 13px; opacity: 0.9;">å½“å‰å¯è°ƒä¼‘ä½™é¢</div>
            <div class="total-display">{{ total.toFixed(1) }} <small style="font-size: 18px">å¤©</small></div>
        </div>
    </el-card>

    <div style="text-align: center; margin-bottom: 20px;">
        <el-button type="primary" icon="el-icon-document-add" round @click="openDialog('ADD')">ç™»è®°è®°å½•</el-button>
        <el-button icon="el-icon-refresh" circle @click="fetchData"></el-button>
    </div>

    <el-table :data="logs" stripe size="small" style="width: 100%; border-radius: 10px;" v-if="user">
        <el-table-column prop="logDate" label="æ—¥æœŸ" width="105"></el-table-column>
        <el-table-column label="å¤©æ•°" width="75">
            <template slot-scope="scope">
                <span :class="scope.row.amount > 0 ? 'type-plus' : 'type-minus'">
                    {{ scope.row.amount > 0 ? '+' + scope.row.amount : scope.row.amount }}
                </span>
            </template>
        </el-table-column>
        <el-table-column prop="note" label="å¤‡æ³¨" show-overflow-tooltip></el-table-column>
        <el-table-column label="æ“ä½œ" width="80" align="right">
            <template slot-scope="scope">
                <el-button type="text" icon="el-icon-edit" @click="openDialog('EDIT', scope.row)"></el-button>
                <el-button type="text" icon="el-icon-delete" style="color: #F56C6C" @click="handleDelete(scope.row)"></el-button>
            </template>
        </el-table-column>
    </el-table>

    <el-dialog title="ğŸ‘¥ æˆå‘˜ç®¡ç†" :visible.sync="memberDialogVisible" width="95%">
        <div v-for="u in userList" :key="u" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
            <span>{{ u }}</span>
            <div>
                <el-button size="mini" type="text" @click="renameMember(u)">æ”¹å</el-button>
                <el-button size="mini" type="text" style="color: #F56C6C" @click="removeMember(u)">åˆ é™¤</el-button>
                <el-button size="mini" type="primary" plain @click="switchUser(u)" v-if="u !== user">åˆ‡æ¢</el-button>
            </div>
        </div>
    </el-dialog>

    <el-dialog :title="isEdit ? 'ç¼–è¾‘è®°å½•' : 'æ–°å¢ç™»è®°'" :visible.sync="dialogVisible" width="90%" center>
        <el-form label-position="top">
            <el-form-item label="è®°å½•ç±»å‹">
                <el-radio-group v-model="form.type" size="medium" style="width: 100%; display: flex;">
                    <el-radio-button label="plus" style="flex:1">åŠ ç­ (+)</el-radio-button>
                    <el-radio-button label="minus" style="flex:1">è°ƒä¼‘ (-)</el-radio-button>
                </el-radio-group>
            </el-form-item>
            <el-form-item label="æ—¥æœŸ">
                <el-date-picker v-model="form.logDate" type="date" style="width: 100%" value-format="yyyy-MM-dd"></el-date-picker>
            </el-form-item>
            <el-form-item label="å¤©æ•°">
                <el-input-number v-model="form.displayAmount" :precision="1" :step="0.5" :min="0.1" style="width: 100%"></el-input-number>
                <div v-if="form.type === 'minus'" style="font-size: 12px; color: #F56C6C; margin-top: 5px;">
                    * é¢„è®¡æ‰£å‡åä½™é¢ï¼š{{ (total - (isEdit ? Math.abs(oldAmount) : 0) - form.displayAmount).toFixed(1) }} å¤©
                </div>
            </el-form-item>
            <el-form-item label="å¤‡æ³¨">
                <el-input v-model="form.note" placeholder="å¤‡æ³¨ä¿¡æ¯"></el-input>
            </el-form-item>
        </el-form>
        <div slot="footer">
            <el-button @click="dialogVisible = false">å–æ¶ˆ</el-button>
            <el-button type="primary" @click="submitForm" :loading="loading">ç¡®è®¤ä¿å­˜</el-button>
        </div>
    </el-dialog>

    <div class="footer">ä¸¥è°¨ç‰ˆè°ƒä¼‘ç³»ç»Ÿ Â· è‡ªåŠ¨é˜²æ­¢ä½™é¢è´Ÿæ•°</div>
</div>

<script>
AV.init({
  appId: "Mz4sDbBvDWL73JIex95G2Oyk-gzGzoHsz",
  appKey: "drSmabDFOB0U5L0p49KVBqWP",
  serverURL: "https://mz4sdbbv.lc-cn-n1-shared.com" 
});
const OTLog = AV.Object.extend('OTLog');

new Vue({
    el: '#app',
    data: {
        user: localStorage.getItem('ot_user') || '',
        userList: JSON.parse(localStorage.getItem('ot_user_list')) || [],
        loading: false,
        total: 0,
        logs: [],
        dialogVisible: false,
        memberDialogVisible: false,
        isEdit: false,
        oldAmount: 0, // è®°å½•ä¿®æ”¹å‰çš„å€¼ï¼Œç”¨äºç²¾å‡†æ ¡éªŒ
        form: { id: '', type: 'plus', logDate: '', displayAmount: 1, note: '' }
    },
    mounted() {
        if (!this.user) this.forceLogin();
        else this.fetchData();
    },
    methods: {
        async fetchData() {
            if (!this.user) return;
            this.loading = true;
            try {
                const query = new AV.Query('OTLog');
                query.equalTo('user', this.user);
                query.descending('logDate');
                const res = await query.find();
                this.logs = res.map(r => ({ id: r.id, logDate: r.get('logDate'), amount: r.get('amount'), note: r.get('note') }));
                this.total = this.logs.reduce((sum, r) => sum + r.amount, 0);
            } finally { this.loading = false; }
        },
        forceLogin() {
            this.$prompt('è¯·è¾“å…¥å§“å', 'åˆå§‹åŒ–', { confirmButtonText: 'ç¡®å®š', showCancelButton: !!this.user })
            .then(({ value }) => {
                if (!this.userList.includes(value)) this.userList.push(value);
                this.user = value;
                this.saveLocal();
                this.fetchData();
            });
        },
        saveLocal() {
            localStorage.setItem('ot_user', this.user);
            localStorage.setItem('ot_user_list', JSON.stringify(this.userList));
        },
        openDialog(mode, row = null) {
            this.isEdit = mode === 'EDIT';
            if (this.isEdit) {
                this.oldAmount = row.amount; // æš‚å­˜æ—§å€¼
                this.form = {
                    id: row.id,
                    type: row.amount >= 0 ? 'plus' : 'minus',
                    logDate: row.logDate,
                    displayAmount: Math.abs(row.amount),
                    note: row.note
                };
            } else {
                this.form = { id: '', type: 'plus', logDate: new Date().toISOString().split('T')[0], displayAmount: 1, note: '' };
            }
            this.dialogVisible = true;
        },
        async submitForm() {
            // --- æ ¸å¿ƒæ ¡éªŒé€»è¾‘ï¼šé˜²æ­¢æ€»å¤©æ•°å˜è´Ÿ ---
            const finalDelta = this.form.type === 'plus' ? this.form.displayAmount : -this.form.displayAmount;
            
            let projectedTotal = 0;
            if (this.isEdit) {
                // ä¿®æ”¹æ€ï¼šå½“å‰æ€»æ•° - æ‰æ—§è®°å½•çš„å€¼ + æ–°è¾“å…¥çš„å€¼
                projectedTotal = this.total - this.oldAmount + finalDelta;
            } else {
                // æ–°å¢æ€ï¼šå½“å‰æ€»æ•° + æ–°è¾“å…¥çš„å€¼
                projectedTotal = this.total + finalDelta;
            }

            if (projectedTotal < 0) {
                this.$message.error(`æäº¤å¤±è´¥ï¼å‰©ä½™è°ƒä¼‘å¤©æ•°ä¸è¶³ï¼ˆè®¡ç®—ç»“æœä¸º ${projectedTotal} å¤©ï¼‰`);
                return; // æ‹¦æˆªï¼Œä¸æ‰§è¡Œåç»­ä¿å­˜
            }

            this.loading = true;
            try {
                const log = this.isEdit ? AV.Object.createWithoutData('OTLog', this.form.id) : new OTLog();
                if (!this.isEdit) log.set('user', this.user);
                log.set('logDate', this.form.logDate);
                log.set('amount', finalDelta);
                log.set('note', this.form.note);
                await log.save();
                this.$message.success('äº‘ç«¯åŒæ­¥æˆåŠŸ');
                this.dialogVisible = false;
                this.fetchData();
            } finally { this.loading = false; }
        },
        async renameMember(oldName) {
            const { value: newName } = await this.$prompt('æ–°å§“å', 'é‡å‘½å', { inputValue: oldName });
            if (newName && newName !== oldName) {
                this.loading = true;
                const query = new AV.Query('OTLog');
                query.equalTo('user', oldName);
                const records = await query.find();
                records.forEach(r => r.set('user', newName));
                await AV.Object.saveAll(records);
                const idx = this.userList.indexOf(oldName);
                this.userList.splice(idx, 1, newName);
                if (this.user === oldName) this.user = newName;
                this.saveLocal();
                this.fetchData();
                this.loading = false;
            }
        },
        async removeMember(target) {
            await this.$confirm(`ç¡®å®šå½»åº•åˆ é™¤ ${target} åŠå…¶æ‰€æœ‰è®°å½•ï¼Ÿ`, 'é«˜å±æ“ä½œ');
            this.loading = true;
            const query = new AV.Query('OTLog');
            query.equalTo('user', target);
            const records = await query.find();
            await AV.Object.destroyAll(records);
            this.userList = this.userList.filter(u => u !== target);
            if (this.user === target) {
                this.user = this.userList[0] || '';
                if (!this.user) { this.saveLocal(); location.reload(); return; }
            }
            this.saveLocal();
            this.fetchData();
            this.loading = false;
        },
        switchUser(u) {
            this.user = u;
            this.saveLocal();
            this.fetchData();
            this.memberDialogVisible = false;
        },
        async handleDelete(row) {
            await this.$confirm('åˆ é™¤æ­¤æ¡è®°å½•ï¼Ÿ');
            // åˆ é™¤è®°å½•ä¹Ÿè¦æ ¡éªŒï¼Ÿä¸ï¼Œåˆ é™¤é€šå¸¸æ˜¯å¢åŠ ä½™é¢ï¼ˆå¦‚æœæ˜¯è°ƒä¼‘è®°å½•ï¼‰æˆ–å‡å°‘ä½™é¢ï¼ˆåŠ ç­è®°å½•ï¼‰ã€‚
            // ä½†å¦‚æœåˆ é™¤ä¸€æ¡åŠ ç­è®°å½•å¯¼è‡´æ€»æ•°å˜è´Ÿï¼Œæˆ‘ä»¬ä¹Ÿåº”è¯¥æç¤ºã€‚
            if (this.total - row.amount < 0) {
                return this.$message.error('æ— æ³•åˆ é™¤ï¼šåˆ é™¤æ­¤è®°å½•ä¼šå¯¼è‡´è°ƒä¼‘ä½™é¢ä¸è¶³ï¼');
            }
            await AV.Object.createWithoutData('OTLog', row.id).destroy();
            this.fetchData();
        },
        handleUserCommand(cmd) {
            if (cmd === 'ADD_NEW') this.forceLogin();
            else if (cmd === 'MANAGE_MEMBERS') this.memberDialogVisible = true;
            else if (cmd === 'LOGOUT') { localStorage.removeItem('ot_user'); location.reload(); }
        }
    }
})
</script>
</body>
</html>
