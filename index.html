<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è°ƒä¼‘ç®¡å®¶ - äº‘ç«¯åŒæ­¥ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <script src="https://unpkg.com/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body { background-color: #f0f2f5; margin: 0; padding: 10px; font-family: "PingFang SC", "Helvetica Neue", Arial, sans-serif; }
        .app-container { max-width: 1200px; margin: 0 auto; }
        .header-card { 
            background: linear-gradient(135deg, #1890ff 0%, #36cfc9 100%); 
            color: white; border-radius: 12px; border: none; margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(24, 144, 255, 0.2);
        }
        .total-display { font-size: 42px; font-weight: bold; margin: 10px 0; }
        .footer { text-align: center; color: #909399; font-size: 12px; margin-top: 20px; }
        .chart-container { height: 400px; width: 100%; }
        .card-title { font-weight: bold; margin-bottom: 15px; display: block; color: #303133; }
        
        @media (max-width: 768px) {
            .el-col { width: 100% !important; margin-bottom: 10px; }
            .header-card { margin-bottom: 10px; }
            .total-display { font-size: 32px; }
        }
    </style>
</head>
<body>
<div id="app" class="app-container">
    <el-row :gutter="15">
        <el-col :span="10">
            <el-card class="header-card" v-loading="loading">
                <div v-if="user" style="display: flex; justify-content: space-between; align-items: center;">
                    <el-tag effect="dark" size="small" style="background: rgba(255,255,255,0.3); border:none;">ğŸ‘¤ {{ user }}</el-tag>
                    <el-dropdown @command="handleUserCommand">
                        <span style="color: white; cursor: pointer; font-size: 14px;">ç®¡ç† <i class="el-icon-arrow-down"></i></span>
                        <el-dropdown-menu slot="dropdown">
                            <el-dropdown-item command="MANAGE_MEMBERS" icon="el-icon-user-solid">æˆå‘˜ç®¡ç† ({{ userList.length }})</el-dropdown-item>
                            <el-dropdown-item command="ADD_NEW" icon="el-icon-plus">æ–°æˆå‘˜ç™»å½•</el-dropdown-item>
                            <el-dropdown-item command="LOGOUT" icon="el-icon-switch-button" style="color: #F56C6C;">æ³¨é”€æœ¬æœº</el-dropdown-item>
                        </el-dropdown-menu>
                    </el-dropdown>
                </div>
                <div v-if="user" style="text-align: center; margin-top: 10px;">
                    <div style="font-size: 13px; opacity: 0.9;">æˆ‘çš„è°ƒä¼‘ä½™é¢</div>
                    <div class="total-display">{{ myTotal.toFixed(1) }} <small style="font-size: 16px">å¤©</small></div>
                </div>
            </el-card>

            <el-card style="border-radius: 12px;">
                <div style="text-align: center; margin-bottom: 15px;">
                    <el-button type="primary" icon="el-icon-plus" round @click="openDialog('ADD')">ç™»è®°è®°å½•</el-button>
                    <el-button icon="el-icon-refresh" circle @click="fetchAllData"></el-button>
                </div>
                <el-table :data="myLogs" stripe size="mini" style="width: 100%" max-height="350" empty-text="æš‚æ— è®°å½•ï¼Œå¿«å»ç™»è®°å§">
                    <el-table-column prop="logDate" label="æ—¥æœŸ" width="100"></el-table-column>
                    <el-table-column label="å˜åŠ¨" width="60">
                        <template slot-scope="scope">
                            <span :style="{color: scope.row.amount > 0 ? '#67C23A' : '#F56C6C', fontWeight:'bold'}">
                                {{ scope.row.amount > 0 ? '+' + scope.row.amount : scope.row.amount }}
                            </span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="note" label="å¤‡æ³¨" show-overflow-tooltip></el-table-column>
                    <el-table-column label="æ“ä½œ" width="50">
                        <template slot-scope="scope">
                            <el-button type="text" icon="el-icon-delete" style="color: #F56C6C" @click="handleDelete(scope.row)"></el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </el-card>
        </el-col>

        <el-col :span="14">
            <el-card style="border-radius: 12px; min-height: 480px;">
                <span class="card-title"><i class="el-icon-data-analysis"></i> å…¨å‘˜è°ƒä¼‘ä½™é‡å¯¹æ¯” (å¤©)</span>
                <div id="mainChart" class="chart-container"></div>
            </el-card>
        </el-col>
    </el-row>

    <el-dialog :title="isEdit ? 'ç¼–è¾‘è®°å½•' : 'æ–°å¢ç™»è®°'" :visible.sync="dialogVisible" :width="responsiveWidth" center>
        <el-form label-position="top">
            <el-form-item label="è®°å½•ç±»å‹">
                <el-radio-group v-model="form.type" size="medium" style="width: 100%; display: flex;">
                    <el-radio-button label="plus" style="flex:1">åŠ ç­ (+)</el-radio-button>
                    <el-radio-button label="minus" style="flex:1">è°ƒä¼‘ (-)</el-radio-button>
                </el-radio-group>
            </el-form-item>
            <el-form-item label="æ—¥æœŸ">
                <el-date-picker v-model="form.logDate" type="date" style="width: 100%" value-format="yyyy-MM-dd" :editable="false"></el-date-picker>
            </el-form-item>
            <el-form-item label="å˜åŠ¨å¤©æ•°">
                <el-input-number v-model="form.displayAmount" :precision="1" :step="0.5" :min="0.1" style="width: 100%"></el-input-number>
                <div v-if="form.type === 'minus'" style="font-size: 12px; color: #F56C6C; margin-top: 5px;">
                    é¢„è®¡æ‰£å‡åä½™é¢ï¼š{{ (myTotal - form.displayAmount).toFixed(1) }} å¤©
                </div>
            </el-form-item>
            <el-form-item label="å¤‡æ³¨">
                <el-input v-model="form.note" placeholder="å¤‡æ³¨å†…å®¹"></el-input>
            </el-form-item>
        </el-form>
        <div slot="footer">
            <el-button @click="dialogVisible = false">å–æ¶ˆ</el-button>
            <el-button type="primary" @click="submitForm" :loading="loading">ä¿å­˜</el-button>
        </div>
    </el-dialog>

    <el-dialog title="ğŸ‘¥ æˆå‘˜ç®¡ç†" :visible.sync="memberDialogVisible" :width="responsiveWidth">
        <div v-for="u in userList" :key="u" style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0;">
            <span style="font-size: 14px; font-weight: 500;">{{ u }} <el-tag v-if="u === user" size="mini" type="success">å½“å‰</el-tag></span>
            <div>
                <el-button size="mini" type="text" icon="el-icon-edit" @click="renameMember(u)">æ”¹å</el-button>
                <el-button size="mini" type="text" icon="el-icon-delete" style="color: #F56C6C" @click="removeMember(u)">åˆ é™¤</el-button>
                <el-button size="mini" type="primary" plain @click="switchUser(u)" v-if="u !== user">åˆ‡æ¢</el-button>
            </div>
        </div>
        <div v-if="userList.length === 0" style="text-align: center; color: #999; padding: 20px;">æš‚æ— äº‘ç«¯æˆå‘˜</div>
    </el-dialog>

    <div class="footer">å¤šäººäº‘ç«¯åŒæ­¥ç³»ç»Ÿ Â· è·¨è®¾å¤‡æ•°æ®ä¸€è‡´</div>
</div>

<script>
AV.init({
  appId: "Mz4sDbBvDWL73JIex95G2Oyk-gzGzoHsz",
  appKey: "drSmabDFOB0U5L0p49KVBqWP",
  serverURL: "https://mz4sdbbv.lc-cn-n1-shared.com" 
});
const OTLog = AV.Object.extend('OTLog');

new Vue({
    el: '#app',
    data: {
        user: localStorage.getItem('ot_user') || '',
        userList: [], // ç°åœ¨é€šè¿‡äº‘ç«¯å®æ—¶è®¡ç®—
        loading: false,
        myTotal: 0,
        myLogs: [],
        allStats: [],
        dialogVisible: false,
        memberDialogVisible: false,
        isEdit: false,
        form: { id: '', type: 'plus', logDate: '', displayAmount: 1, note: '' },
        chart: null,
        screenWidth: window.innerWidth
    },
    computed: {
        responsiveWidth() { return this.screenWidth < 768 ? '95%' : '500px'; }
    },
    mounted() {
        if (!this.user) this.forceLogin();
        else this.fetchAllData();
        window.onresize = () => {
            this.screenWidth = window.innerWidth;
            if (this.chart) this.chart.resize();
        };
    },
    methods: {
        // --- æ ¸å¿ƒï¼šäº‘ç«¯åŒæ­¥æˆå‘˜åå• ---
        async fetchAllData() {
            this.loading = true;
            try {
                const query = new AV.Query('OTLog');
                query.limit(1000);
                const results = await query.find();
                
                // 1. åŠ¨æ€ç”Ÿæˆ userList (ä»æ‰€æœ‰äº‘ç«¯è®°å½•ä¸­æå–ä¸é‡å¤çš„å§“å)
                const cloudUsers = [...new Set(results.map(r => r.get('user')))];
                this.userList = cloudUsers;

                // 2. æå–æˆ‘çš„æ•°æ®
                const myRecords = results.filter(r => r.get('user') === this.user);
                this.myLogs = myRecords.map(r => ({
                    id: r.id, logDate: r.get('logDate'), amount: r.get('amount'), note: r.get('note')
                })).sort((a, b) => b.logDate.localeCompare(a.logDate));
                this.myTotal = this.myLogs.reduce((sum, r) => sum + r.amount, 0);

                // 3. å…¨å‘˜ç»Ÿè®¡
                const statsMap = {};
                results.forEach(r => {
                    const u = r.get('user');
                    statsMap[u] = (statsMap[u] || 0) + r.get('amount');
                });
                this.allStats = Object.keys(statsMap).map(name => ({
                    name: name, value: statsMap[name]
                })).sort((a, b) => a.value - b.value);
                
                this.renderChart();
            } finally { this.loading = false; }
        },
        renderChart() {
            if (!this.chart) this.chart = echarts.init(document.getElementById('mainChart'));
            this.chart.setOption({
                tooltip: { trigger: 'axis' },
                grid: { left: '3%', right: '12%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value' },
                yAxis: { type: 'category', data: this.allStats.map(i => i.name) },
                series: [{
                    name: 'ä½™é‡', type: 'bar',
                    data: this.allStats.map(i => ({
                        value: i.value,
                        itemStyle: { color: i.value > 0 ? '#67C23A' : '#F56C6C' }
                    })),
                    label: { show: true, position: 'right', formatter: '{c}å¤©' }
                }]
            }, true);
        },
        openDialog(mode) {
            this.isEdit = mode === 'EDIT';
            this.form = { id: '', type: 'plus', logDate: new Date().toISOString().split('T')[0], displayAmount: 1, note: '' };
            this.dialogVisible = true;
        },
        async submitForm() {
            const delta = this.form.type === 'plus' ? this.form.displayAmount : -this.form.displayAmount;
            if (this.myTotal + delta < 0) return this.$message.error('ä½™é¢ä¸è¶³ï¼');
            this.loading = true;
            try {
                const log = new OTLog();
                log.set('user', this.user);
                log.set('logDate', this.form.logDate);
                log.set('amount', delta);
                log.set('note', this.form.note);
                await log.save();
                this.dialogVisible = false;
                this.$message.success('å·²åŒæ­¥è‡³äº‘ç«¯');
                await this.fetchAllData();
            } finally { this.loading = false; }
        },
        forceLogin() {
            this.$prompt('è¯·è¾“å…¥å§“å', 'äº‘ç«¯æˆå‘˜ç™»å½•', { 
                confirmButtonText: 'ç¡®å®š', 
                showCancelButton: !!this.user,
                inputPlaceholder: 'è¯·è¾“å…¥å§“åï¼Œå¦‚å§“åå·²å­˜åœ¨åˆ™è¿›å…¥å¯¹åº”è´¦æˆ·'
            }).then(({ value }) => {
                if(!value.trim()) return;
                this.user = value.trim();
                localStorage.setItem('ot_user', this.user);
                this.fetchAllData();
            });
        },
        async handleDelete(row) {
            await this.$confirm('åˆ é™¤è®°å½•ï¼Ÿ');
            if (this.myTotal - row.amount < 0) return this.$message.error('åˆ é™¤åä½™é¢ä¸ºè´Ÿï¼Œå·²æ‹¦æˆª');
            this.loading = true;
            await AV.Object.createWithoutData('OTLog', row.id).destroy();
            await this.fetchAllData();
        },
        handleUserCommand(cmd) {
            if (cmd === 'MANAGE_MEMBERS') this.memberDialogVisible = true;
            else if (cmd === 'ADD_NEW') this.forceLogin();
            else if (cmd === 'LOGOUT') {
                this.$confirm('æ³¨é”€åï¼Œä¸‹æ¬¡éœ€é‡æ–°è¾“å…¥å§“åç™»å½•ã€‚ç¡®è®¤ï¼Ÿ').then(() => {
                    localStorage.removeItem('ot_user');
                    location.reload();
                });
            }
        },
        switchUser(u) {
            this.user = u;
            localStorage.setItem('ot_user', u);
            this.fetchAllData();
            this.memberDialogVisible = false;
            this.$message.success(`å·²åˆ‡æ¢è‡³ï¼š${u}`);
        },
        async renameMember(oldName) {
            const { value: newName } = await this.$prompt('æ–°å§“å', 'æˆå‘˜æ”¹å', { inputValue: oldName });
            if (newName && newName !== oldName) {
                this.loading = true;
                const query = new AV.Query('OTLog');
                query.equalTo('user', oldName);
                const records = await query.find();
                records.forEach(r => r.set('user', newName));
                await AV.Object.saveAll(records);
                if (this.user === oldName) {
                    this.user = newName;
                    localStorage.setItem('ot_user', newName);
                }
                await this.fetchAllData();
                this.$message.success('äº‘ç«¯æ•°æ®å·²å…¨é‡é‡å‘½å');
            }
        },
        async removeMember(target) {
            await this.$confirm(`ç¡®å®šè¦å½»åº•åˆ é™¤æˆå‘˜ "${target}" åŠå…¶æ‰€æœ‰äº‘ç«¯è®°å½•å—ï¼Ÿ`, 'å±é™©æ“ä½œ', { type: 'error' });
            this.loading = true;
            const query = new AV.Query('OTLog');
            query.equalTo('user', target);
            const records = await query.find();
            await AV.Object.destroyAll(records);
            if (this.user === target) {
                localStorage.removeItem('ot_user');
                location.reload();
            } else {
                await this.fetchAllData();
            }
        }
    }
})
</script>
</body>
</html>
