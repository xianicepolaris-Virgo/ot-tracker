<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å›¢é˜Ÿè°ƒä¼‘ç®¡å®¶ - Cloud Version</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <script src="https://unpkg.com/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: "PingFang SC","Helvetica Neue",Arial,sans-serif; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .header-card { background: linear-gradient(120deg, #1565C0, #1E88E5); color: white; border-radius: 12px; margin-bottom: 20px; }
        .total-num { font-size: 50px; font-weight: bold; margin: 15px 0; }
        .user-tag { background: rgba(255,255,255,0.2); border: none; color: white; margin-bottom: 10px; }
    </style>
</head>
<body>
<div id="app" class="container">
    <el-card class="header-card" v-loading="loading">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
                <el-tag class="user-tag" effect="dark" size="medium">{{ currentUser }} çš„è´¦æˆ·</el-tag>
                <div style="font-size: 14px; opacity: 0.8;">å‰©ä½™å¯ç”¨è°ƒä¼‘</div>
                <div class="total-num">{{ totalDays.toFixed(1) }} <span style="font-size: 20px;">å¤©</span></div>
            </div>
            <el-select v-model="currentUser" @change="fetchData" placeholder="åˆ‡æ¢ç”¨æˆ·" size="small" style="width: 120px">
                <el-option v-for="u in userList" :key="u" :label="u" :value="u"></el-option>
                <el-option label="+ æ–°ç”¨æˆ·" value="new_user" @click.native="addNewUser"></el-option>
            </el-select>
        </div>
    </el-card>

    <el-card style="border-radius: 12px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-around;">
            <el-button type="primary" icon="el-icon-circle-plus-outline" circle @click="addLog(1, 'åŠ ç­')"></el-button>
            <span style="line-height: 40px;">åŠ ç­ 1å¤©</span>
            <el-button type="success" icon="el-icon-circle-plus-outline" circle @click="addLog(0.5, 'åŠ ç­')"></el-button>
            <span style="line-height: 40px;">åŠ ç­ 0.5å¤©</span>
            <el-button type="warning" icon="el-icon-remove-outline" circle @click="showUseDialog = true"></el-button>
            <span style="line-height: 40px;">ç”¨è°ƒä¼‘</span>
            <el-button icon="el-icon-edit" circle @click="showAdjustDialog = true"></el-button>
            <span style="line-height: 40px;">æ ¡å‡†</span>
        </div>
    </el-card>

    <el-card style="border-radius: 12px;">
        <div slot="header">ğŸ“‘ æœ€è¿‘å˜åŠ¨æ˜ç»†</div>
        <el-table :data="logs" stripe size="small" v-loading="loading">
            <el-table-column prop="date" label="æ—¶é—´" width="110"></el-table-column>
            <el-table-column label="å˜åŠ¨">
                <template slot-scope="scope">
                    <b :style="{color: scope.row.amount >= 0 ? '#67C23A' : '#F56C6C'}">
                        {{ scope.row.amount > 0 ? '+' + scope.row.amount : scope.row.amount }}
                    </b>
                </template>
            </el-table-column>
            <el-table-column prop="note" label="å¤‡æ³¨"></el-table-column>
        </el-table>
    </el-card>

    <el-dialog title="æˆ‘è¦è°ƒä¼‘" :visible.sync="showUseDialog" width="90%">
        <el-input-number v-model="form.amount" :step="0.5" :min="0.5" style="width:100%"></el-input-number>
        <el-input v-model="form.note" placeholder="å¤‡æ³¨ï¼ˆå¦‚ï¼šå‘¨äº”ä¸‹åˆï¼‰" style="margin-top:15px"></el-input>
        <div slot="footer"><el-button type="primary" @click="addLog(-form.amount, form.note || 'ä½¿ç”¨è°ƒä¼‘')" block>ç¡®è®¤æäº¤</el-button></div>
    </el-dialog>

    <el-dialog title="æ ¡å‡†/è®¾å®šæ€»æ•°" :visible.sync="showAdjustDialog" width="90%">
        <p style="font-size: 12px; color: #999;">è¿™å°†æ–°å¢ä¸€æ¡â€œæ ¡å‡†â€è®°å½•ï¼Œä½¿æ€»æ•°è¾¾åˆ°ä½ è®¾å®šçš„å€¼ã€‚</p>
        <el-input-number v-model="adjustVal" :step="0.5" style="width:100%"></el-input-number>
        <div slot="footer"><el-button type="danger" @click="handleAdjust">ç¡®è®¤æ ¡å‡†</el-button></div>
    </el-dialog>
</div>

<script>
// --- æ ¸å¿ƒé…ç½®ï¼šè¯·å¡«å…¥ä½ çš„ LeanCloud ä¿¡æ¯ ---
AV.init({
  appId: "Mz4sDbBvDWL73JIex95G2Oyk-gzGzoHsz", 
  appKey: "drSmabDFOB0U5L0p49KVBqWP",
  serverURL: "https://mz4sdbbv.lc-cn-n1-shared.com" // è‹¥æ— åŸŸåï¼ŒLeanCloudåå°ä¼šæä¾›ä¸€ä¸ªä¸´æ—¶æµ‹è¯•åŸŸå
});
const OTLog = AV.Object.extend('OTLog');

new Vue({
    el: '#app',
    data: {
        loading: false,
        currentUser: 'é»˜è®¤ç”¨æˆ·',
        userList: ['é»˜è®¤ç”¨æˆ·', 'å¼ ä¸‰', 'æå››'],
        logs: [],
        totalDays: 0,
        showUseDialog: false,
        showAdjustDialog: false,
        form: { amount: 0.5, note: '' },
        adjustVal: 0
    },
    mounted() { this.fetchData(); },
    methods: {
        // ä»äº‘ç«¯æŠ“å–æ•°æ®
        async fetchData() {
            if (this.currentUser === 'new_user') return;
            this.loading = true;
            try {
                const query = new AV.Query('OTLog');
                query.equalTo('user', this.currentUser);
                query.descending('createdAt');
                const results = await query.find();
                
                this.logs = results.map(r => ({
                    id: r.id,
                    date: r.createdAt.toLocaleDateString(),
                    amount: r.get('amount'),
                    note: r.get('note')
                }));
                this.totalDays = this.logs.reduce((sum, r) => sum + r.amount, 0);
            } finally { this.loading = false; }
        },
        // æ–°å¢è®°å½•åˆ°äº‘ç«¯
        async addLog(amt, note) {
            this.loading = true;
            const log = new OTLog();
            log.set('user', this.currentUser);
            log.set('amount', amt);
            log.set('note', note);
            await log.save();
            this.$message.success('å·²åŒæ­¥è‡³äº‘ç«¯');
            this.showUseDialog = false;
            this.fetchData();
        },
        // æ ¡å‡†é€»è¾‘ï¼šè®¡ç®—å·®å€¼å¹¶è¡¥å…¨
        handleAdjust() {
            const diff = this.adjustVal - this.totalDays;
            this.addLog(diff, 'æ‰‹åŠ¨æ ¡å‡†æ€»æ•°');
            this.showAdjustDialog = false;
        },
        addNewUser() {
            this.$prompt('è¯·è¾“å…¥æ–°åŒäº‹çš„åå­—', 'æ–°å¢ç”¨æˆ·', {
                confirmButtonText: 'ç¡®å®š',
                cancelButtonText: 'å–æ¶ˆ'
            }).then(({ value }) => {
                if(value) {
                    this.userList.push(value);
                    this.currentUser = value;
                    this.fetchData();
                }
            });
        }
    }
})
</script>
</body>
</html>